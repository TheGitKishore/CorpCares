<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Report</title>
  <style>
    body { font-family: Arial; padding: 30px; }
    pre { border: 1px solid #000; padding: 10px; background: #f9f9f9; }
    .category { margin: 10px 0; padding: 10px; border-left: 3px solid #28a745; }
    .week { margin: 5px 0; padding: 5px; background: #f0f0f0; }
    .input-group { margin: 10px 0; }
    .input-group label { margin-right: 10px; }
  </style>
</head>
<body>
  <h3>Generate Monthly Engagement Report by Category</h3>
  <div class="input-group">
    <label for="reportYear">Year:</label>
    <input type="number" id="reportYear" min="2020" max="2030" placeholder="YYYY" />
    <label for="reportMonth">Month:</label>
    <input type="number" id="reportMonth" min="1" max="12" placeholder="1-12" />
  </div>
  <button id="loadReport">Generate</button>
  <pre id="report"></pre>

  <script>
    document.getElementById('loadReport').addEventListener('click', async () => {
      const token = localStorage.getItem("sessionToken") || '';
      const year = document.getElementById("reportYear").value;
      const month = document.getElementById("reportMonth").value;
      const resultsDiv = document.getElementById("report");
      resultsDiv.innerHTML = '';

      if (!token) {
        resultsDiv.innerHTML = `<p>Session token missing. Please log in.</p>`;
        return;
      }

      let query = '';
      if (year && month) {
        query = `?year=${year}&month=${month}`;
      } else if (year || month) {
        resultsDiv.innerHTML = `<p>Please provide both year and month, or leave both empty for current month.</p>`;
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/api/reports/monthly${query}`, {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await res.json();
        if (!data.success || !data.report) {
          throw new Error(data.message || "Unexpected response");
        }

        const { 
          year: reportYear,
          month: reportMonth,
          monthName,
          totalRequests,
          totalCompleted,
          overallCompletionRate,
          categoryBreakdown,
          weeklyTrend
        } = data.report;

        resultsDiv.innerHTML = `
          <strong>Report Period:</strong> ${monthName} ${reportYear}<br/>
          <strong>Total Requests:</strong> ${totalRequests}<br/>
          <strong>Total Completed:</strong> ${totalCompleted}<br/>
          <strong>Overall Completion Rate:</strong> ${(overallCompletionRate * 100).toFixed(2)}%<br/>
          <br/>
          <strong>Category Breakdown:</strong><br/>
        `;

        resultsDiv.innerHTML += categoryBreakdown.map(cat => `
          <div class="category">
            <strong>Category:</strong> ${cat.category}<br/>
            <strong>Total Requests:</strong> ${cat.totalRequests}<br/>
            <strong>Completed Requests:</strong> ${cat.completedRequests}<br/>
            <strong>Completion Rate:</strong> ${(cat.completionRate * 100).toFixed(2)}%<br/>
            <strong>Avg Shortlist Count:</strong> ${cat.avgShortlistCount}<br/>
            <strong>Avg Save Count:</strong> ${cat.avgSaveCount}
          </div>
        `).join('');

        resultsDiv.innerHTML += `<br/><strong>Weekly Trend:</strong><br/>`;
        resultsDiv.innerHTML += weeklyTrend.map(week => `
          <div class="week">
            <strong>Week of ${week.week}:</strong> 
            ${week.totalRequests} requests (${week.completedRequests} completed)
          </div>
        `).join('');
      } catch (error) {
        resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>