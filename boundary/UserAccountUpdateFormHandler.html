<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Update User Account</title>
  <style>
    body { background:#fff; font-family:Arial,sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; }
    form { background:#fff; border:1px solid #000; padding:30px; width:340px; display:flex; flex-direction:column; gap:15px; }
    label { font-weight:bold; color:#000; }
    input, select { padding:8px; border:1px solid #000; background:#fff; color:#000; }
    small { color:#555; }
    button { padding:10px; background:#000; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#333; }
  </style>
</head>
<body>
  <form id="updateForm">
    <div style="font-weight:bold; margin-bottom:8px;">Update User</div>

    <label for="username">Username</label>
    <input type="text" id="username" required />

    <label for="fullName">Full Name</label>
    <input type="text" id="fullName" required />

    <label for="email">Email</label>
    <input type="email" id="email" required />

    <label for="password">New Password <small>(leave blank to keep existing)</small></label>
    <input type="password" id="password" placeholder="Leave empty to keep" />

    <label for="roleName">Role Name</label>
    <select id="roleName">
      <option value="User Admin">User Admin</option>
      <option value="Platform Manager">Platform Manager</option>
      <option value="CSR Rep">CSR Rep</option>
      <option value="PIN">PIN</option>
    </select>

    <label for="isActive">Is Active</label>
    <select id="isActive">
      <option value="true">True</option>
      <option value="false">False</option>
    </select>

    <button type="submit">Update Account</button>
  </form>

  <script type="module">
    const API = "http://localhost:3000";
    const token = localStorage.getItem("sessionToken") || "";
    const userIdRaw = sessionStorage.getItem("userId");
    const userId = userIdRaw ? parseInt(userIdRaw, 10) : NaN;
    
      // If userId missing, jump straight to lookup (no alert, no fetch)
    if (!Number.isFinite(userId)) {
      window.location.replace("UserAccountUpdateLookUpFormHandler.html");
      // IMPORTANT: stop executing any more code on this page
      throw new Error("Redirecting to lookup");
    }

    const authHeader = () => ({
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    });

    // Prefill only runs when we definitely have userId
    (async () => {
      try {
        const res = await fetch(`${API}/api/accounts/${userId}`, { headers: authHeader() });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "Failed to load user");

        document.getElementById("username").value = data.user.username || "";
        document.getElementById("fullName").value = data.user.fullName || "";
        document.getElementById("email").value = data.user.email || "";
        document.getElementById("roleName").value = data.user.profile || "PIN";
        document.getElementById("isActive").value = String(Boolean(data.user.isActive));
      } catch (e) {
        // If anything goes wrong (missing token, network, etc.) just send them to lookup
        window.location.replace("UserAccountUpdateLookUpFormHandler.html");
      }
    })();

    // Submit update
    document.getElementById("updateForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        username: document.getElementById("username").value.trim(),
        fullName: document.getElementById("fullName").value.trim(),
        email: document.getElementById("email").value.trim(),
        // send empty string to keep existing password
        password: document.getElementById("password").value,
        profile: document.getElementById("roleName").value,   // roleName string
        isActive: document.getElementById("isActive").value === "true"
      };

      try {
        const res = await fetch(`${API}/api/accounts/${userId}`, {
          method: "PUT",
          headers: authHeader(),
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "Update failed");

        alert("User updated successfully.");
        document.getElementById("password").value = "";
      } catch (e) {
        alert(e.message);
      }
    });
  </script>
</body>
</html>
